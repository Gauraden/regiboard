<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>F1772 Online</title>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
	<script type="text/javascript">
	  var kPollPeriod  = 250; // msec
		var debug_node   = 0;
		var message_node = 0;
		var canvas_node  = 0;
		var canvas_ctx   = 0;
		var ready        = true;
		var frame        = new Image();
		var timeout      = 0;
		var disconnected = true;
		var mouse        = {'x': 0, 'y': 0, 'state': 0, 'send': false};
		var poll_tm_out  = 0;

		function Debug(msg) {
			if (debug_node == 0)
				return;
			var tm = new Date();
			debug_node.innerHTML += '> ' + tm.toLocaleTimeString() +
						                  ": " + msg + '</br>'
		}

		function UpdateState() {
			if (message_node == 0)
				return;
			if (disconnected)
				message_node.innerHTML = 'Нет связи с устройством';
			else
				message_node.innerHTML = 'Просмотр работает только в браузерах: Chrome, Chromium!';
		}

    function GetReqParams() {
      var req = '';//'?stamp=' + (new Date().getUTCSeconds()) + '&';
			if (mouse.send != true)
			  return req;
      mouse.send = false;
  		return ('?' + req + 'x=' + mouse.x + '&y=' + mouse.y + '&s=' + mouse.state);
    }

		function OnLoad() {
			debug_node   = document.getElementById("debug");
			message_node = document.getElementById("message");
			canvas_node  = document.getElementById("screen");
			canvas_ctx   = canvas_node.getContext('2d');
		  /*
		  canvas_node.onmousedown = function(event) {
		    mouse.x     = event.x;
 		    mouse.y     = event.y;
  		  mouse.state = 0;
 		    mouse.send  = true;
		  };*/
		  
			canvas_node.onmousedown = function(event) {
		    mouse.x     = event.x;
 		    mouse.y     = event.y;
 		    mouse.state = 1;
 		    mouse.send  = true;
		  };
		  
		  function UpdatePollTimeout() {
		    if (poll_tm_out != undefined && poll_tm_out != 0)
  			  clearTimeout(poll_tm_out);
        poll_tm_out = setTimeout(PollFrame, kPollPeriod);
		  }
		  
			function PollFrame() {
				if (ready == false) {
					timeout++;
					if (timeout < 10) 
						return UpdatePollTimeout();
					timeout = 0;
					disconnected = true;
				}
				UpdateState();
				ready = false;
				frame.src = 'http://' + document.domain + ':8080' + GetReqParams();
			}
      
		  frame.onload = function() {
		    /*var frame_lim = 10;
		    var frame_num = 0;
		    disconnected = false;
   		  var fade_int = setInterval(function() {
   		  	canvas_ctx.save();
   		  	canvas_ctx.globalAlpha = (frame_num / frame_lim);
			    canvas_ctx.drawImage(frame, 0, 0);
			    canvas_ctx.restore();
			    frame_num++;
			    if (frame_num > frame_lim) {
			      clearInterval(fade_int);
			      ready = true;
			    }
			  }, kPollPeriod / frame_lim);*/
	    	canvas_ctx.save();
		    canvas_ctx.drawImage(this, 0, 0);
		    canvas_ctx.restore();
	      ready        = true;
		    disconnected = false;
        UpdatePollTimeout();
		  };
		  
		  frame.onerror = function() {
	      ready        = false;
		    disconnected = true;
        UpdatePollTimeout();
		  };
		  
		  frame.onabort = function() {
	      ready        = false;
		    disconnected = true;
        UpdatePollTimeout();
		  };
		  
      UpdatePollTimeout();
		}
		</script>
	</head>
	<body onload="OnLoad()" style="padding: 0px; margin: 0px">
		<canvas id="screen" width="1024" height="768" style="border: 1px solid #000000;">
		</canvas>
	  <div id="message"></div>
		<!--<div id="debug" style="overflow:scroll"></div>-->
	</body>
</html>
